---
title: "Markdown file"
author: "Marissa Freed"
date: "4/30/2018"
output: 
  html_document:
    code_folding: hide
    df_print: paged
    fig_width: 10
    fig_length: 8
    theme: lumen
    fig_caption: true
---

```{r setup, include = FALSE}
library(tidyverse)
library(mdsr)
library(RMySQL)
library(data.table)
imdb <- dbConnect_scidb(dbname = "imdb")
```


## OPTIONS FOR TOPIC
- [] underrepresentation of women in blockbuster films (highest grossing of all time)
- [] ratings of films vs gender distribution of characters
- [] combination of both? looking at highest rated and blockbuster films and seeing how many are female led




issue: the gross info category shows weekly gross for every week the film was open, so I think we're better off looking solely at opening weekend sales.

```{r first filters}
gendergross <- imdb %>%
  dbGetQuery("SELECT n.name as actor, gender, person_id, ci.movie_id, person_role_id as char_id,  cn.name as character_name, title, production_year, mi.info as language, mi2.info as gross
from imdb.name n
join imdb.cast_info ci on n.id = ci.person_id
join imdb.char_name cn on cn.id = ci.person_role_id
join imdb.title t on t.id = ci.movie_id
JOIN imdb.movie_info mi ON mi.movie_id = ci.movie_id
JOIN imdb.movie_info mi2 ON mi2.movie_id = ci.movie_id
WHERE mi.info_type_id IN (4) AND mi.info = 'English'
  AND kind_id = 1
  AND mi2.info_type_id = 108 AND mi2.info like '%(USA%'
  and production_year > 1999
ORDER BY title;")

```

```{r}
gendergross <- gendergross %>%
  mutate(gross_string = str_extract(gross, "^\\$[0-9]+,[0-9]{3},[0-9]{3}"),
         gross_numeric = parse_number(gross_string)) %>%
  filter(grepl("\\(USA\\)", gross)) %>%
  arrange(desc(gross_numeric))

char_total <- gendergross %>%
  group_by(movie_id) %>%
  summarize(total_people = n_distinct(char_id))

gender_total <- gendergross %>%
  group_by(movie_id, gender) %>%
  summarize(gendertot = n_distinct(char_id)) %>%
  full_join(char_total, by = "movie_id")

gender_total1 <- gender_total %>%
  filter(gender == 'f') %>%
  group_by(movie_id) %>%
  mutate(ratiof = gendertot/total_people)

```

```{r}
english_table <- imdb %>%
  dbGetQuery("SELECT t.id, title, kind_id, production_year, movie_id, info_type_id, info AS language
FROM imdb.title t 
join imdb.movie_info m on t.id = m.movie_id
having kind_id = 1 
and info like '%English%'
and production_year > 1999
and info_type_id = 4;")

gross_table <- imdb %>%
  dbGetQuery("SELECT t.id, title, kind_id, production_year, info_type_id, info
FROM imdb.title t 
join imdb.movie_info m on t.id = m.movie_id
having kind_id = 1 
and production_year > 1999
and info_type_id = 108
and info like '%USA%';")

joined_gross <-  gross_table %>%
  inner_join(english_table, by = c("id", "title", "kind_id", "production_year")) %>%
  mutate(gross_string = str_extract(info, "^\\$[0-9]+,[0-9]{3},[0-9]{3}"),
         gross_numeric = parse_number(gross_string)) %>%
  filter(grepl("\\(USA\\)", info)) %>%
  arrange(desc(gross_numeric))
joined_gross

gender_gross <- joined_gross %>%
  full_join(gender_total1, by = "movie_id") %>%
  select(c(1, 2, 4, 11, 12, 13, 14, 15))

gender_gross
```

```{r}
#Top 100 Rated Films
votes_table <- imdb %>%
  dbGetQuery("SELECT t.id, t.title, t.production_year, 
  miv.info AS votes
FROM title t
JOIN movie_info_idx AS miv ON miv.movie_id = t.id
WHERE t.kind_id = 1
  AND miv.info_type_id = 100
  AND miv.info > 100000;")

ratings_table <- imdb %>%
  dbGetQuery("SELECT t.id, t.title, t.production_year, mir.info AS rating
FROM title t
JOIN movie_info_idx AS mir ON mir.movie_id = t.id
WHERE t.kind_id = 1
  AND mir.info_type_id = 101;")

votes_table2 <- as.data.table(votes_table)
ratings_table2 <- as.data.table(ratings_table)

joined_votes <- votes_table2 %>%
  inner_join(ratings_table2, by = c("id", "title", "production_year")) %>%
  filter(production_year > 1999) %>%
  arrange(desc(rating))
```





